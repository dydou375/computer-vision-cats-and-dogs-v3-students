# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš¨ GRAFANA ALERT RULES - RÃ¨gles d'alerting MLOps
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ OBJECTIF
# DÃ©finit les rÃ¨gles d'alerte Grafana Unified Alerting pour monitoring proactif.
# Format YAML gÃ©nÃ©rÃ© par Grafana UI (export), structurÃ© pour provisioning.
#
# ğŸ“š CONCEPTS CLÃ‰S
# - Alert rule : condition + donnÃ©es + seuil + durÃ©e
# - Query (data) : source mÃ©triques (Prometheus, SQL, etc.)
# - Condition (threshold) : Ã©valuation boolÃ©enne (>, <, ==)
# - for : durÃ©e avant dÃ©clenchement (anti-faux positifs)
# - noDataState/execErrState : comportement si donnÃ©es manquantes
#
# ğŸ”— WORKFLOW
# Query Prometheus â†’ Reduce â†’ Threshold â†’ Fire/Resolve â†’ Contact Point (Discord)
#
# âš ï¸ FORMAT COMPLEXE
# Ce YAML est verbeux car exportÃ© depuis Grafana UI.
# CrÃ©ation manuelle difficile â†’ privilÃ©gier crÃ©ation UI puis export.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apiVersion: 1

groups:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“ GROUPE D'ALERTES : Computer Vision Monitoring
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - orgId: 1
    # ğŸ¢ Organization ID (dÃ©faut : 1)
    
    name: cv-monitoring
    # ğŸ·ï¸ Nom du groupe (identifiant unique)
    # Regroupe alertes liÃ©es logiquement (mÃªme systÃ¨me/service)
    
    folder: Computer Vision
    # ğŸ“‚ Dossier Grafana UI (organisation visuelle)
    # CrÃ©Ã© automatiquement si inexistant
    
    interval: 1m
    # â±ï¸ FrÃ©quence d'Ã©valuation des rÃ¨gles (toutes les 1 minute)
    # Compromis : 30s = rÃ©actif mais charge CPU, 5m = Ã©conome mais lent
    
    rules:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”´ ALERTE 1 : Base de donnÃ©es dÃ©connectÃ©e (CRITICAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-db-disconnected
        # ğŸ†” Identifiant unique de la rÃ¨gle (ne pas modifier aprÃ¨s crÃ©ation)
        # UtilisÃ© par Grafana pour tracking Ã©tat (firing/resolved)
        
        title: Database Disconnected
        # ğŸ“Œ Titre affichÃ© dans UI et notifications Discord
        
        condition: C
        # ğŸ¯ RÃ©fÃ©rence Ã  la query dÃ©finissant la condition de dÃ©clenchement
        # Ici : refId "C" = threshold sur query "A"
        
        data:
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ğŸ“Š QUERY A : RÃ©cupÃ©ration mÃ©trique Prometheus
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - refId: A
            # ğŸ”¤ Identifiant de query (rÃ©fÃ©rencÃ© par queries suivantes)
            
            queryType: ''
            # Type de query (vide = standard Prometheus)
            
            relativeTimeRange:
              from: 600  # -10 minutes
              to: 0      # maintenant
            # â° FenÃªtre temporelle de la query (10 derniÃ¨res minutes)
            # Permet d'Ã©valuer tendance rÃ©cente, pas juste valeur instantanÃ©e
            
            datasourceUid: prometheus
            # ğŸ”Œ Source de donnÃ©es (configurÃ©e dans datasources.yml)
            # Format : nom du datasource provisionnÃ©
            
            model:
              editorMode: code
              # ğŸ“ Mode Ã©dition (code vs builder)
              # code = PromQL brut, builder = UI graphique
              
              expr: cv_database_connected
              # ğŸ“Š EXPRESSION PROMQL
              # MÃ©trique Gauge binaire (1 = connectÃ©, 0 = dÃ©connectÃ©)
              # Mise Ã  jour par update_db_status() dans routes.py
              
              instant: true
              # âš¡ Query instantanÃ©e (pas de range)
              # true = derniÃ¨re valeur uniquement
              # false = sÃ©rie temporelle complÃ¨te
              
              range: false
              # ğŸ¯ Pas de range query (cohÃ©rent avec instant: true)
              
              refId: A
              # ğŸ”¤ RÃ©fÃ©rence (dupliquÃ©e, requis format Grafana)
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ğŸ§® QUERY C : Threshold (condition de dÃ©clenchement)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - refId: C
            datasourceUid: __expr__
            # ğŸ”§ Datasource interne Grafana (expressions/transformations)
            # __expr__ = moteur d'Ã©valuation Grafana (pas Prometheus)
            
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  # ğŸ“ Ã‰VALUATEUR : valeur < 1 ?
                  # lt = less than
                  # cv_database_connected < 1 â†’ true si = 0 (dÃ©connectÃ©)
                  
                  reducer:
                    type: last
                  # ğŸ“Š RÃ©duction : prendre derniÃ¨re valeur
                  # Alternatives : avg, min, max, sum
                  
                  type: query
                  # Type de condition (basÃ© sur query)
              
              expression: A
              # ğŸ¯ Ã‰value query A (cv_database_connected)
              
              type: threshold
              # ğŸ”” Type d'expression : seuil binaire (true/false)
        
        noDataState: Alerting
        # ğŸš¨ Comportement si aucune donnÃ©e disponible
        # Alerting = dÃ©clenche alerte (assume problÃ¨me)
        # Alternatives : NoData (pas d'alerte), OK (assume normal)
        # 
        # ğŸ’¡ CHOIX ICI : Alerting
        # Si mÃ©trique absente â†’ app probablement crashÃ©e â†’ alerter
        
        execErrState: Alerting
        # âš ï¸ Comportement si erreur d'exÃ©cution query
        # Exemple : Prometheus down, query invalide
        # Alerting = principe de prÃ©caution (mieux notifier que manquer incident)
        
        for: 1m
        # â³ DurÃ©e avant dÃ©clenchement (condition vraie pendant 1 min)
        # Ã‰vite faux positifs (blips rÃ©seau courts)
        # Court (1m) car DB down = incident critique
        
        annotations:
          description: L'API ne peut plus accÃ©der Ã  PostgreSQL
          # ğŸ“„ Description dÃ©taillÃ©e (affichÃ©e dans Discord embed)
          
          summary: Base de donnÃ©es PostgreSQL dÃ©connectÃ©e
          # ğŸ“‹ RÃ©sumÃ© court (titre notification)
        
        labels:
          severity: critical
          # ğŸ”´ SÃ©vÃ©ritÃ© maximale
          # UtilisÃ© par notification policies pour routage
        
        isPaused: false
        # â–¶ï¸ Ã‰tat actif (false = alertes envoyÃ©es)
        # true = temporairement dÃ©sactivÃ© (maintenance)

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸŸ  ALERTE 2 : Latence d'infÃ©rence Ã©levÃ©e (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-high-latency
        # ğŸ†” Identifiant unique pour l'alerte de latence

        title: High Inference Latency
        # ğŸ“Œ Titre affichÃ© dans Grafana et les notifications

        condition: C
        # ğŸ¯ Condition basÃ©e sur la query "C" (threshold sur la latence moyenne)

        data:
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ğŸ“Š QUERY A : Calcul latence moyenne sur 5 minutes
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300   # -5 minutes
              to: 0       # maintenant
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: rate(cv_inference_time_seconds_sum[5m]) / rate(cv_inference_time_seconds_count[5m])
              # Latence moyenne (en secondes) sur les 5 derniÃ¨res minutes
              instant: true
              range: false
              refId: A

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ğŸ§® QUERY C : Threshold (latence > 2 secondes)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  # Condition : latence moyenne > 2s
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold

        noDataState: NoData
        # Si pas de donnÃ©es (pas de prÃ©dictions rÃ©centes) â†’ pas d'alerte

        execErrState: Alerting
        # Si erreur d'exÃ©cution de la rÃ¨gle â†’ on prÃ©fÃ¨re alerter

        for: 2m
        # La condition doit rester vraie pendant 2 minutes avant dÃ©clenchement

        annotations:
          description: "Latence moyenne des prÃ©dictions > 2 secondes sur les 5 derniÃ¨res minutes."
          summary: "Latence d'infÃ©rence Ã©levÃ©e (WARNING)"

        labels:
          severity: warning

        isPaused: false

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸŸ  ALERTE 3 : Feedback nÃ©gatif majoritaire (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-high-negative-feedback
        title: High Negative Feedback Ratio
        condition: C

        data:
          # Query A : ratio feedbacks nÃ©gatifs / total
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600   # 10 minutes
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: rate(cv_user_feedback_total{feedback_type="negative"}[10m]) / rate(cv_user_feedback_total[10m])
              instant: true
              range: false
              refId: A

          # Query C : seuil > 0.5
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.5
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold

        noDataState: NoData
        execErrState: Alerting
        for: 10m

        annotations:
          description: "Plus de 50% des feedbacks des 10 derniÃ¨res minutes sont nÃ©gatifs."
          summary: "Taux de feedbacks nÃ©gatifs trop Ã©levÃ©"

        labels:
          severity: warning

        isPaused: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ STRUCTURE ALERT RULE GRAFANA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PIPELINE D'Ã‰VALUATION (exemple alerte latence)
# 1. Query A (Prometheus) : rÃ©cupÃ¨re mÃ©trique histogram
# 2. Calcul (PromQL) : rate(sum) / rate(count) â†’ latence moyenne
# 3. Query B (Reduce) : extrait derniÃ¨re valeur â†’ scalaire
# 4. Query C (Threshold) : compare scalaire > seuil â†’ boolÃ©en
# 5. For duration : condition vraie pendant N minutes ?
# 6. Fire : dÃ©clenche notification â†’ contact point (Discord)
#
# Ã‰TATS POSSIBLES
# - Normal : condition false
# - Pending : condition true mais <for duration (pas encore notifiÃ©)
# - Firing : condition true depuis >for duration (notification envoyÃ©e)
# - Resolved : Ã©tait firing, maintenant normal (notification rÃ©solution)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸ CRÃ‰ATION NOUVELLES ALERTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MÃ‰THODE RECOMMANDÃ‰E (UI Grafana)
# 1. Dashboard â†’ panel existant â†’ Edit
# 2. Tab "Alert" â†’ Create alert rule
# 3. Configurer condition graphiquement
# 4. Test avec "Preview" (donnÃ©es rÃ©elles)
# 5. Save
# 6. Exporter : Alerting â†’ Alert rules â†’ Export as YAML
# 7. Ajouter Ã  cv-alerts.yml
#
# âš ï¸ CRÃ‰ATION MANUELLE YAML (difficile)
# Format complexe, queries imbriquÃ©es, refIds multiples
# PrivilÃ©gier UI â†’ export pour Ã©viter erreurs syntaxe
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ TESTS ET DEBUG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# TEST ALERTE (forcer dÃ©clenchement)
# - DB disconnect : docker compose stop postgres
# - High latency : surcharger CPU (stress test)
# - No activity : arrÃªter frontend/stop prÃ©dictions
#
# MONITORING ALERTES
# Grafana UI â†’ Alerting â†’ Alert rules
# - Ã‰tat : Normal, Pending, Firing
# - Historique : derniers dÃ©clenchements
# - Silences : dÃ©sactiver temporairement
#
# DEBUG QUERY
# Grafana UI â†’ Explore â†’ datasource Prometheus
# - Copier expr depuis cv-alerts.yml
# - Tester query isolÃ©ment
# - VÃ©rifier valeurs retournÃ©es
#
# LOGS GRAFANA
# docker compose logs grafana | grep -i alert
# - "provisioning alert rules"
# - "alert rule ... is firing"
# - Erreurs d'Ã©valuation
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š RESSOURCES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# - Unified Alerting : https://grafana.com/docs/grafana/latest/alerting/
# - Provisioning : https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/
# - Query expressions : https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/expression-queries/
# - PromQL functions : https://prometheus.io/docs/prometheus/latest/querying/functions/
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•